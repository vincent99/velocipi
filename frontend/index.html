<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Velocipi</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 1rem;
        background: #111;
        color: #eee;
      }
      #last-ping {
        font-size: 0.9rem;
        color: #aaa;
        margin-bottom: 0.5rem;
      }

      /* Frame image is 2409x704. The transparent window is:
         x: 621–1803 (width 1182), y: 167–480 (height 313).
         Frame width is set by JS so the whole frame fits in the window
         at an exact integer scale of the 256px screenshot. */
      #frame-wrap {
        position: relative;
        display: inline-block;
        /* width set by JS */
      }
      #frame-img {
        display: block;
        width: 100%;
        height: auto;
      }
      /* Window hole percentages derived from frame dimensions:
         left=621/2409  right=606/2409  top=167/704  bottom=224/704 */
      #air-reading {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        margin: 0.75rem 0;
        font-size: 0.95rem;
      }
      #air-reading .reading-group {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
      }
      #air-reading .label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #888;
      }
      #air-reading .value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #eee;
        font-variant-numeric: tabular-nums;
      }
      #air-reading.stale .value {
        color: #555;
      }

      #tpms {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin: 0.75rem 0;
        max-width: 480px;
      }
      .tire-card {
        background: #1e1e1e;
        border: 1px solid #333;
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
      }
      .tire-card.stale {
        opacity: 0.4;
      }
      .tire-position {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #888;
        margin-bottom: 0.3rem;
      }
      .tire-psi {
        font-size: 1.4rem;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        color: #eee;
        line-height: 1;
      }
      .tire-psi.warn {
        color: #f0a500;
      }
      .tire-psi.flat {
        color: #e05555;
      }
      .tire-meta {
        font-size: 0.75rem;
        color: #888;
        margin-top: 0.25rem;
        font-variant-numeric: tabular-nums;
      }
      .tire-state {
        font-size: 0.7rem;
        color: #666;
        margin-top: 0.15rem;
      }

      #screen-window {
        position: absolute;
        left: 25.78%;
        right: 25.11%;
        top: 23.72%;
        bottom: 31.82%;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      /* Screenshot fills the window exactly — it is always 4:1 */
      #screenshot {
        width: 100%;
        height: 100%;
        object-fit: fill;
        display: block;
        image-rendering: pixelated;
      }
    </style>
  </head>
  <body>
    <div>
      <span id="last-ping">Waiting for ping...</span>
      <button
        id="reload-btn"
        onclick="ws.send(JSON.stringify({ type: 'reload' }))"
      >
        Reload
      </button>
    </div>
    <div id="air-reading" class="stale">
      <div class="reading-group">
        <span class="label">Temp</span>
        <span class="value" id="ar-temp">--</span>
      </div>
      <div class="reading-group">
        <span class="label">Humidity</span>
        <span class="value" id="ar-humidity">--</span>
      </div>
      <div class="reading-group">
        <span class="label">Pressure</span>
        <span class="value" id="ar-pressure">--</span>
      </div>
      <div class="reading-group">
        <span class="label">Altitude</span>
        <span class="value" id="ar-altitude">--</span>
      </div>
      <div class="reading-group">
        <span class="label">Dewpoint</span>
        <span class="value" id="ar-dewpoint">--</span>
      </div>
      <div class="reading-group">
        <span class="label">Ambient Light</span>
        <span class="value" id="ar-lux">--</span>
      </div>
    </div>
    <div id="tpms">
      <div class="tire-card stale" id="tire-FL">
        <div class="tire-position">FL</div>
        <div class="tire-psi" id="tire-FL-psi">--</div>
        <div class="tire-meta" id="tire-FL-meta">-- &middot; --</div>
        <div class="tire-state" id="tire-FL-state">--</div>
      </div>
      <div class="tire-card stale" id="tire-FR">
        <div class="tire-position">FR</div>
        <div class="tire-psi" id="tire-FR-psi">--</div>
        <div class="tire-meta" id="tire-FR-meta">-- &middot; --</div>
        <div class="tire-state" id="tire-FR-state">--</div>
      </div>
      <div class="tire-card stale" id="tire-RL">
        <div class="tire-position">RL</div>
        <div class="tire-psi" id="tire-RL-psi">--</div>
        <div class="tire-meta" id="tire-RL-meta">-- &middot; --</div>
        <div class="tire-state" id="tire-RL-state">--</div>
      </div>
      <div class="tire-card stale" id="tire-RR">
        <div class="tire-position">RR</div>
        <div class="tire-psi" id="tire-RR-psi">--</div>
        <div class="tire-meta" id="tire-RR-meta">-- &middot; --</div>
        <div class="tire-state" id="tire-RR-state">--</div>
      </div>
    </div>
    <div id="frame-wrap">
      <img id="frame-img" src="/img/frame.png" alt="frame" />
      <div id="screen-window">
        <img id="screenshot" alt="screenshot" />
      </div>
    </div>
    <script>
      const SCREENSHOT_W = 256;
      // frame.png is 2409px wide; the screenshot window is 1182px of that.
      const FRAME_W = 2409;
      const WINDOW_W = 1182;

      const frameWrap = document.getElementById("frame-wrap");

      // Minimum frame width when screenshot is 1x (256px)
      const FRAME_MIN_W = Math.round((SCREENSHOT_W * FRAME_W) / WINDOW_W);

      function resize() {
        const available = document.documentElement.clientWidth - 32; // subtract body margin
        const scale = Math.max(1, Math.floor(available / FRAME_MIN_W));
        const framePx = scale * FRAME_MIN_W;
        frameWrap.style.width = framePx + "px";
      }

      resize();
      window.addEventListener("resize", resize);

      const ws = new WebSocket(`ws://${location.host}/ws`);
      const wsScreen = new WebSocket(`ws://${location.host}/screen`);
      const pingEl = document.getElementById("last-ping");
      const imgEl = document.getElementById("screenshot");
      const airEl = document.getElementById("air-reading");

      wsScreen.onmessage = (e) => {
        let msg;
        try { msg = JSON.parse(e.data); } catch { return; }
        if (msg.type === "screenshot")
          imgEl.src = "data:image/png;base64," + msg.data;
      };
      wsScreen.onerror = (e) => console.error("screen ws error", e);

      function fmt(n, decimals) {
        return n == null ? "--" : n.toFixed(decimals);
      }

      function updateAirReading(r) {
        document.getElementById("ar-temp").textContent =
          fmt(r.tempF, 1) + "°F / " + fmt(r.tempC, 1) + "°C";
        document.getElementById("ar-humidity").textContent =
          fmt(r.humidity, 1) + "%";
        document.getElementById("ar-pressure").textContent =
          fmt(r.pressureInches, 2) + " inHg";
        document.getElementById("ar-altitude").textContent =
          fmt(r.pressureFeet, 0) + " ft";
        document.getElementById("ar-dewpoint").textContent =
          fmt(r.dewpointF, 1) + "°F";
        airEl.classList.remove("stale");
      }

      function updateTire(t) {
        const pos = t.position || "??";
        const card = document.getElementById("tire-" + pos);
        if (!card) return;

        const psiEl = document.getElementById("tire-" + pos + "-psi");
        const metaEl = document.getElementById("tire-" + pos + "-meta");
        const stateEl = document.getElementById("tire-" + pos + "-state");

        const psi = fmt(t.pressurePsi, 1) + " PSI";
        psiEl.textContent = psi;
        psiEl.className = "tire-psi";
        if (t.inflation === "flat") psiEl.classList.add("flat");
        else if (t.inflation === "low" || t.inflation === "decreasing")
          psiEl.classList.add("warn");

        metaEl.textContent =
          fmt(t.tempF, 0) + "°F · " + fmt(t.battery, 0) + "% batt";
        stateEl.textContent = t.inflation + " · " + t.rotation;
        card.classList.remove("stale");
      }

      ws.onmessage = (e) => {
        let msg;
        try {
          msg = JSON.parse(e.data);
        } catch {
          return;
        }
        if (msg.type === "ping") pingEl.textContent = "Last ping: " + msg.time;
        if (msg.type === "airReading" && msg.reading)
          updateAirReading(msg.reading);
        if (msg.type === "luxReading" && msg.lux != null)
          document.getElementById("ar-lux").textContent =
            fmt(msg.lux, 1) + " lux";
        if (msg.type === "tpms" && msg.tire) updateTire(msg.tire);
      };

      ws.onerror = (e) => console.error("ws error", e);
      ws.onclose = () => {
        pingEl.textContent = "Disconnected";
      };

      // Forward key events to chromedp via the server.
      const RELAY_KEYS = new Set([
        "ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown",
        "Enter", "[", "]", ";", "'", ",", ".",
      ]);

      function relayKey(eventType, key) {
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "key", eventType, key }));
        }
      }

      document.addEventListener("keydown", (e) => {
        if (RELAY_KEYS.has(e.key)) {
          e.preventDefault();
          relayKey("keydown", e.key);
        }
      });
      document.addEventListener("keyup", (e) => {
        if (RELAY_KEYS.has(e.key)) {
          e.preventDefault();
          relayKey("keyup", e.key);
        }
      });
    </script>
  </body>
</html>
